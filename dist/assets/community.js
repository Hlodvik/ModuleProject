import{d as e,b as t,a as n,s as o}from"./main-chunk.js";import{q as i,c as a,w as s,g as r,a as d,d as c,o as l,b as m,k as u,l as g,s as f,m as y,h as p,i as h,j as w}from"./firebase-chunk.js";import"https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";async function E(e,t,n,o,i){var a;const s=document.getElementById("join-container");if(!s)return;s.innerHTML="";if(null==(a=i.members)?void 0:a.includes(o))s.innerHTML='\n            <div class="dropdown">\n                <button class="custom-btn-dark dropdown-toggle" id="joinedDropdown" data-bs-toggle="dropdown">\n                    Joined\n                </button>\n                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="joinedDropdown">\n                    <li><a class="dropdown-item" href="#" id="favoriteCommunity">⭐ Favorite</a></li>\n                    <li><a class="dropdown-item text-danger" href="#" id="leaveCommunity">❌ Leave Community</a></li>\n                </ul>\n            </div>\n        ',document.getElementById("leaveCommunity").onclick=async()=>{try{await m(t,{members:g(n)}),await m(e,{members:g(o)});const i=await d(e);E(e,t,n,o,i.data())}catch(i){console.error("Error leaving community:",i)}},document.getElementById("favoriteCommunity").onclick=()=>{console.log("Favorite feature can be implemented here.")};else{const i=document.createElement("button");i.textContent="Join Community",i.classList.add("custom-btn-orange"),i.onclick=async()=>{try{await m(t,{members:u(n)}),await m(e,{members:u(o)});const i=await d(e);E(e,t,n,o,i.data())}catch(i){console.error("Error joining community:",i)}},s.appendChild(i)}}async function v(e,t=800,n=800){return new Promise(((o,i)=>{const a=new FileReader;a.onload=function(e){const i=new Image;i.onload=function(){const e=document.createElement("canvas");let a=i.width,s=i.height;if(a>t||s>n){const e=a/s;a>s?(a=t,s=a/e):(s=n,a=s*e)}e.width=a,e.height=s;e.getContext("2d").drawImage(i,0,0,a,s),e.toBlob((e=>o(e)),"image/jpeg",.85)},i.src=e.target.result},a.onerror=i,a.readAsDataURL(e)}))}document.addEventListener("DOMContentLoaded",(async()=>{const n=document.getElementById("communityName"),o=document.getElementById("communityPic"),l=document.getElementById("banner"),m=document.getElementById("bio"),u=document.getElementById("admins"),g=document.getElementById("members"),f=document.getElementById("memCount"),y=window.location.pathname.split("/")[2];if(window.location.pathname.startsWith("/co/"))try{const p=i(a(e,"communities"),s("subdomain","==",y)),h=await r(p);if(h.empty)return void console.error("Community not found:",y);const w=h.docs[0],E=w.data(),v=w.id;n&&(n.textContent=E.name),m&&(m.textContent=E.bio||""),o&&l&&function(e,t){o&&e?(o.src=e,localStorage.setItem("communityProfilePic",e)):console.warn("No profile picture found. Skipping.");l&&t?(l.src=t,localStorage.setItem("communityBannerPic",t)):console.warn("No banner found. Skipping.")}(E.communityPicUrl,E.bannerUrl),u&&async function(t,n){const o=await Promise.all(n.map((async t=>{const n=await d(c(e,"users",t));return n.exists()?n.data().username:"Unknown Admin"})));t.innerHTML=o.map((e=>`<li>${e}</li>`)).join("")}(u,E.admins),g&&async function(t,n){if(!n||0===n.length)return void(t.innerHTML="<li>No members yet</li>");const o=await Promise.all(n.map((async t=>{try{const n=await d(c(e,"users",t));if(n.exists()){const e=n.data();return`\n                            <li class="d-flex align-items-center my-2">\n                                <img src="${e.profilePic||"/images/default-picture.png"}" class="rounded-circle me-2" width="30" height="30">\n                                <a href="/u/${e.username}" class="text-white">${e.username}</a>\n                            </li>`}}catch(n){console.error(`Error fetching user ${t}:`,n)}return"Unknown User"})));f.innerHTML=`<strong>Members:</strong> ${n.length}`,t.innerHTML=o.join("")}(g,E.members),t(v)}catch(p){console.error("Error loading community:",p)}})),document.addEventListener("DOMContentLoaded",(function(){if(!document.getElementById("join"))return;const t=window.location.pathname.split("/")[2];t?l(n,(async n=>{const o=c(e,"users",n.uid),l=(await d(o)).data(),m=await async function(t){const n=await r(i(a(e,"communities"),s("subdomain","==",t)));return n.empty?(console.error("Community not found:",t),null):n.docs[0]}(t),u=c(e,"communities",m.id),g=m.id;E(o,u,n.uid,g,l)})):console.error("Community subdomain not found in URL.")})),document.addEventListener("DOMContentLoaded",(function(){const t=document.getElementById("postForm"),i=document.getElementById("postBody"),a=document.getElementById("postTitle"),s=document.getElementById("postMedia");t&&i&&a&&s?t.addEventListener("submit",(function(t){t.preventDefault(),async function(){const t=document.getElementById("postTitle"),i=document.getElementById("postBody"),a=document.getElementById("postMedia"),s=t.value.trim(),r=i.innerHTML.trim();if(!s||!r)return void alert("Title and content cannot be empty.");try{const r=await async function(){var t;const o=n.currentUser;if(!o)return console.error("User not authenticated."),null;const i=window.location.pathname.split("/"),a=i[2];if(!a)return console.error("Community ID not found in URL."),null;const s=c(e,"users",o.uid),r=await d(s),l=r.data().userPostID;r.data().username;const u=c(e,"communities",a),g=await d(u),f=g.data().communityPostID,y=`posts.${a}`;let p=(null==(t=r.data().posts)?void 0:t[a])||0;return p++,await m(s,{[y]:p}),`${f}${l}_${p}`}();if(!r)throw new Error("Failed to generate post ID");let l=[];a.files.length>0&&(l=await async function(e){const t=n.currentUser;if(!t)return console.error("User not authenticated."),[];const i=[],a=[];for(let n of e){const e=await v(n),s=p(o,`post_media/${t.uid}/${Date.now()}_${n.name}`),r=h(s,e).then((async e=>{const t=await w(e.ref);return a.push(t),t}));i.push(r)}return await Promise.all(i),a}(a.files));let g=i.innerHTML;l.forEach((e=>{g=g.replace("[MEDIA_PLACEHOLDER]",`<img src='${e}' alt='Uploaded Image'/>`)}));const E=window.location.pathname.split("/")[2],b=n.currentUser;if(!b)return void console.error("No authenticated user.");await f(c(e,"posts",r),{postID:r,title:s,content:g,communityId:E,postAuthor:username,createdAt:y(),mediaUrls:l});const L=c(e,"users",b.uid);await m(L,{postIDs:u(r)});const I=c(e,"communities",E);await m(I,{posts:u(r)}),alert("Post submitted successfully."),t.value="",i.innerHTML="",a.value="",bootstrap.Modal.getInstance(document.getElementById("createPostModal")).hide()}catch(l){console.error("Error submitting post:",l),alert("Failed to submit post.")}}()})):console.warn("Post form elements missing.")})),document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("postBody"),t=document.getElementById("boldBtn"),n=document.getElementById("italicBtn"),o=document.getElementById("fontSizeBtn"),i=document.getElementById("fontSizeDropdown");if(!(e&&t&&n&&o&&i))return void console.warn("One or more text formatting elements are missing.");let a={bold:!1,italic:!1,fontSize:null};function s(t,n=null){!function(){e.focus();const t=window.getSelection();if(!t.rangeCount){const n=document.createRange();n.selectNodeContents(e),n.collapse(!1),t.removeAllRanges(),t.addRange(n)}}(),document.execCommand(t,!1,n),r()}e.addEventListener("paste",(function(e){e.preventDefault();const t=(e.clipboardData||window.clipboardData).getData("text/plain");document.execCommand("insertText",!1,t)})),t.addEventListener("click",(()=>{s("bold"),a.bold=document.queryCommandState("bold"),r()})),n.addEventListener("click",(()=>{s("italic"),a.italic=document.queryCommandState("italic"),r()}));function r(){t.classList.toggle("active",a.bold),n.classList.toggle("active",a.italic)}i.innerHTML="",[8,10,12,14,16,18,20,24,28,32,34,36,38,40].forEach((t=>{const n=document.createElement("li"),r=document.createElement("a");r.href="#",r.classList.add("dropdown-item"),r.textContent=`${t}px`,r.addEventListener("click",(function(n){n.preventDefault(),s("fontSize",7);e.querySelectorAll("font[size='7']").forEach((e=>{e.removeAttribute("size"),e.style.fontSize=`${t}px`})),a.fontSize=t,o.textContent=`${t}px`})),n.appendChild(r),i.appendChild(n)})),i.addEventListener("click",(function(e){e.stopPropagation()}))})),document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("postBody"),t=document.getElementById("addMediaBtn"),n=document.getElementById("postMedia"),o=document.getElementById("mediaModal"),i=document.getElementById("insertMediaBtn"),a=document.getElementById("mediaPreview");e&&t&&n&&o&&i&&a?(t.addEventListener("click",(()=>{o.classList.add("show"),o.style.display="block"})),n.addEventListener("change",(function(){if(i.disabled=!this.files.length,this.files.length){const e=this.files[0],t=new FileReader;t.onload=function(e){a.innerHTML=`<img src="${e.target.result}" style="max-width: 100%; max-height: 200px;">`},t.readAsDataURL(e)}})),i.addEventListener("click",(function(){if(!n.files.length)return;const t=n.files[0],i=new FileReader;i.onload=function(t){const n=document.createElement("img");n.src=t.target.result,n.style.maxWidth="75vw",n.style.maxHeight="75vh",n.style.cursor="pointer",n.style.display="inline-block",n.style.margin="5px",n.setAttribute("draggable",!1),function(e,t){const n=window.getSelection();if(!n.rangeCount)return void e.appendChild(t);const o=n.getRangeAt(0);o.deleteContents(),o.insertNode(t),n.removeAllRanges();const i=document.createRange();i.setStartAfter(t),i.collapse(!0),n.addRange(i)}(e,n)},i.readAsDataURL(t),o.classList.remove("show"),o.style.display="none"}))):console.warn("One or more media modal elements are missing.")})),document.addEventListener("DOMContentLoaded",(function(){let e,t,n,o,i,a,s=null;function r(r){if(!s)return;let d=r.clientX-e,c=r.clientY-t;if("corner"===a){let e=Math.max(4,Math.min(.6*window.innerWidth,n+d)),t=Math.max(4,Math.min(.6*window.innerHeight,e/i));s.style.width=`${e}px`,s.style.height=`${t}px`}else if("side"===a){let e=Math.max(4,Math.min(.6*window.innerWidth,n+d));s.style.width=`${e}px`}else if("top-bottom"===a){let e=Math.max(4,Math.min(.6*window.innerHeight,o+c));s.style.height=`${e}px`}}function d(){s&&(s.style.cursor="default"),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",d)}function c(e){"Enter"===e.key&&s&&(s.style.cursor="default",s=null,document.removeEventListener("keydown",c))}document.getElementById("postBody").addEventListener("mousemove",(function(e){"IMG"===e.target.tagName&&function(e,t){const n=e.getBoundingClientRect(),o=t.clientX-n.left,i=t.clientY-n.top,a=10;o<a&&i<a||o>n.width-a&&i>n.height-a||o<a&&i>n.height-a||o>n.width-a&&i<a?e.style.cursor="nwse-resize":o<a||o>n.width-a?e.style.cursor="ew-resize":i<a||i>n.height-a?e.style.cursor="ns-resize":e.style.cursor="default"}(e.target,e)})),document.getElementById("postBody").addEventListener("mousedown",(function(l){"IMG"===l.target.tagName&&function(l,m){const u=l.getBoundingClientRect(),g=m.clientX-u.left,f=m.clientY-u.top,y=10;if(e=m.clientX,t=m.clientY,n=l.clientWidth,o=l.clientHeight,i=l.naturalWidth/l.naturalHeight,s=l,g<y&&f<y||g>u.width-y&&f>u.height-y||g<y&&f>u.height-y||g>u.width-y&&f<y)a="corner";else if(g<y||g>u.width-y)a="side";else{if(!(f<y||f>u.height-y))return void(s=null);a="top-bottom"}document.addEventListener("mousemove",r),document.addEventListener("mouseup",d),document.addEventListener("keydown",c)}(l.target,l)}))}));
